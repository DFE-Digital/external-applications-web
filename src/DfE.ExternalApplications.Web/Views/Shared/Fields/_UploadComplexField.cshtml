@using System.Collections
@using System.Text.Json
@using DfE.ExternalApplications.Web.Services
@using DfE.CoreLibs.Contracts.ExternalApplications.Models.Response
@inject IHttpContextAccessor httpContext;
@using Microsoft.AspNetCore.Http.Extensions
@model FieldViewModel
@{
    var applicationId = ViewData["applicationId"] as string ?? Context.Session.GetString("ApplicationId");
    var fieldId = Model.Field.FieldId;

    // Try to get files from ViewData first (for upload page), then from current value (for form integration)
    var files = ViewData[$"{fieldId}_Files"] as IEnumerable<UploadDto>;
    if (files == null || !files.Any())
    {
        if (!string.IsNullOrEmpty(Model.CurrentValue))
        {
            try
            {
                files = JsonSerializer.Deserialize<List<UploadDto>>(Model.CurrentValue);
            }
            catch
            {
                files = new List<UploadDto>();
            }
        }

        files ??= new List<UploadDto>();
    }
    else
    {
        files = files.ToList();
    }

    var successMessage = ViewData[$"{fieldId}_UploadSuccess"] as string;
    var errorMessage = ViewData[$"{fieldId}_UploadError"] as string;
    
    // Check if we're in a form context (has form data) or standalone upload page
    var isFormContext = !string.IsNullOrEmpty(Model.CurrentValue);
}
@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="govuk-notification-banner govuk-notification-banner--success" role="alert" data-module="govuk-notification-banner">
        <div class="govuk-notification-banner__header">
            <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">Success</h2>
        </div>
        <div class="govuk-notification-banner__content">
            <p class="govuk-notification-banner__heading">@successMessage</p>
        </div>
    </div>
}
@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" data-module="govuk-error-summary">
        <h2 class="govuk-error-summary__title" id="error-summary-title">There is a problem</h2>
        <div class="govuk-error-summary__body">
            <ul class="govuk-list govuk-error-summary__list">
                <li>@errorMessage</li>
            </ul>
        </div>
    </div>
}
<!-- Hidden input to store file data for form submission -->
<input type="hidden" name="Data[@fieldId]" value="@Model.CurrentValue" />

@if (!isFormContext)
{
    <!-- Standalone upload form for upload page -->
    <form method="post" asp-page-handler="UploadFile" enctype="multipart/form-data">
        <input type="hidden" name="ApplicationId" value="@applicationId" />
        <input type="hidden" name="FieldId" value="@fieldId" />
        <div class="govuk-form-group">
            <label class="govuk-label" for="upload-file">File</label>
            <input class="govuk-file-upload" id="upload-file" name="UploadFile" type="file" required aria-describedby="upload-file-hint" />
            <div id="upload-file-hint" class="govuk-hint">Select a file to upload</div>
        </div>
        <div class="govuk-form-group">
            <label class="govuk-label" for="upload-name">Name</label>
            <input class="govuk-input" id="upload-name" name="UploadName" type="text" placeholder="File name (optional)" aria-describedby="upload-name-hint" />
            <div id="upload-name-hint" class="govuk-hint">Enter a name for the file (optional)</div>
        </div>
        <div class="govuk-form-group">
            <label class="govuk-label" for="upload-desc">Description</label>
            <input class="govuk-input" id="upload-desc" name="UploadDescription" type="text" placeholder="Description (optional)" aria-describedby="upload-desc-hint" />
            <div id="upload-desc-hint" class="govuk-hint">Enter a description for the file (optional)</div>
        </div>
        <button class="govuk-button" type="submit" aria-label="Upload file">Upload</button>
    </form>
}
else
{
    <!-- Form context - show upload button that opens upload page -->
    <div class="govuk-form-group">
        <label class="govuk-label" for="upload-file">File</label>
        <div class="govuk-hint">Upload files for this field</div>
        <a href="/applications/@ViewData["ReferenceNumber"]/@ViewData["TaskId"]/@ViewData["PageId"]/upload-file?applicationId=@applicationId&fieldId=@fieldId" 
           class="govuk-button govuk-button--secondary" 
           aria-label="Upload files for @Model.Field.Label.Value">
            Upload Files
        </a>
    </div>
}
@if (files.Any())
{
    <h3 class="govuk-heading-m">Uploaded files</h3>
    <table class="govuk-table">
        <thead class="govuk-table__head">
            <tr class="govuk-table__row">
                <th class="govuk-table__header">File name</th>
                <th class="govuk-table__header">Description</th>
                <th class="govuk-table__header">Uploaded on</th>
                <th class="govuk-table__header">Actions</th>
            </tr>
        </thead>
        <tbody class="govuk-table__body">
        @foreach (var file in files)
        {
            <tr class="govuk-table__row">
                <td class="govuk-table__cell">@file.OriginalFileName</td>
                <td class="govuk-table__cell">@file.Description</td>
                <td class="govuk-table__cell">@file.UploadedOn.ToString("g")</td>
                <td class="govuk-table__cell">
                    @if (!isFormContext)
                    {
                        <!-- Standalone upload page - full actions -->
                        <form method="post" asp-page-handler="DownloadFile" style="display:inline">
                            <input type="hidden" name="FileId" value="@file.Id" />
                            <input type="hidden" name="FieldId" value="@fieldId" />
                            <input type="hidden" name="ApplicationId" value="@applicationId" />
                            <govuk-button type="submit" id="download-file" aria-label="Download file @file.OriginalFileName">Download</govuk-button>
                        </form>
                        <form method="post" asp-page-handler="DeleteFile" style="display:inline">
                            <input type="hidden" name="FileId" value="@file.Id" />
                            <input type="hidden" name="FieldId" value="@fieldId" />
                            <input type="hidden" name="ApplicationId" value="@applicationId" />
                            <button type="submit" class="govuk-button govuk-button--warning govuk-button--small" 
                                    data-module="govuk-button"
                                    aria-label="Remove file @file.OriginalFileName"
                                    onclick="return confirm('Are you sure you want to delete this file?');">
                                Remove
                            </button>
                        </form>
                    }
                    else
                    {
                        <!-- Form context - read-only display -->
                        <span class="govuk-hint">Files can be managed from the upload page</span>
                    }
                </td>
            </tr>
        }
        </tbody>
    </table>
} 