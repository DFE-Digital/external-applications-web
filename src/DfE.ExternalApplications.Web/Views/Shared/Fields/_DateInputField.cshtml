@using Microsoft.AspNetCore.Html;
@model DfE.ExternalApplications.Web.Services.FieldViewModel
@{
    var isRequired = Model.Field.Required ?? true;
    var validationAttributes = new HtmlString(Model.ValidationAttributes);
    var labelClasses = Model.Field.Label.IsVisible ? "" : "govuk-visually-hidden";
	// Parse only strict ISO-like formats to avoid culture-based swapping of day/year
	var _formats = new[] { "yyyy-M-d", "yyyy-MM-dd", "yyyy-M-dd", "yyyy-MM-d" };
	DateTime? parsedDate = System.DateTime.TryParseExact(
		Model.CurrentValue,
		_formats,
		System.Globalization.CultureInfo.InvariantCulture,
		System.Globalization.DateTimeStyles.None,
		out DateTime dt
	) ? dt : (DateTime?)null;
	var request = ViewContext?.HttpContext?.Request;
	var hasForm = request?.HasFormContentType == true && string.Equals(request.Method, "POST", StringComparison.OrdinalIgnoreCase);
	var postedDay = hasForm ? request!.Form[$"Data[{Model.Field.FieldId}].day"].ToString() : string.Empty;
	var postedMonth = hasForm ? request!.Form[$"Data[{Model.Field.FieldId}].month"].ToString() : string.Empty;
	var postedYear = hasForm ? request!.Form[$"Data[{Model.Field.FieldId}].year"].ToString() : string.Empty;
	var hasPostedParts = hasForm && (!string.IsNullOrWhiteSpace(postedDay) || !string.IsNullOrWhiteSpace(postedMonth) || !string.IsNullOrWhiteSpace(postedYear));

	// When reloading after redirect (GET), recover parts from stored joined value (e.g., "YYYY-M-D")
	string persistedDay = string.Empty, persistedMonth = string.Empty, persistedYear = string.Empty;
	var hasPersistedParts = false;
	if (!hasPostedParts && parsedDate == null && !string.IsNullOrWhiteSpace(Model.CurrentValue) && Model.CurrentValue.Contains('-'))
	{
		var bits = Model.CurrentValue.Split('-', StringSplitOptions.TrimEntries);
		if (bits.Length == 3)
		{
			persistedYear = bits[0];
			persistedMonth = bits[1];
			persistedDay = bits[2];
			hasPersistedParts = !string.IsNullOrWhiteSpace(persistedDay) || !string.IsNullOrWhiteSpace(persistedMonth) || !string.IsNullOrWhiteSpace(persistedYear);
		}
	}
}

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Find the component wrapper first
    var wrapperRoot = document.getElementById('@Model.Id')
        || document.querySelector('.govuk-date-input[name-prefix="Data[@Model.Field.FieldId]"]')
        || document.querySelector('[data-name-prefix="Data[@Model.Field.FieldId]"]')
        || document.querySelector('.govuk-date-input');

    // Scope queries to the nearest wrapper to avoid cross-field matching
    var wrapper = (wrapperRoot && wrapperRoot.classList && wrapperRoot.classList.contains('govuk-date-input'))
        ? wrapperRoot
        : (wrapperRoot ? wrapperRoot.closest('.govuk-date-input') : null);

    if (!wrapper) return;

    // Resolve inputs inside this wrapper by common suffixes (covers .day and -day naming)
    function q(sel) { return wrapper.querySelector(sel); }
    var day   = q('input[name$=".day"],   input[name$="-day"],   input[id$="-day"],   input[name$=".Day"],   input[name$="-Day"],   input[id$=".Day"],   input[id$="-Day"]');
    var month = q('input[name$=".month"], input[name$="-month"], input[id$="-month"], input[name$=".Month"], input[name$="-Month"], input[id$=".Month"], input[id$="-Month"]');
    var year  = q('input[name$=".year"],  input[name$="-year"],  input[id$="-year"],  input[name$=".Year"],  input[name$="-Year"],  input[id$=".Year"],  input[id$="-Year"]');
    if (!day || !month || !year) return;

    if (wrapper.dataset.liveDateBound === 'true') return;
    wrapper.dataset.liveDateBound = 'true';

    // Determine form group for error styling
    var formGroup = wrapper.closest('.govuk-form-group') || wrapper.parentElement;

    var fieldLabel = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Field.Label?.Value ?? Model.Field.FieldId));
    var missingMsg = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((Model.Field.Label?.Value ?? Model.Field.FieldId) + " must include a day, month and year"));
    var invalidMsg = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((Model.Field.Label?.Value ?? Model.Field.FieldId) + " must be a real date"));

    function setInputsError(show) {
        var cls = 'govuk-input--error';
        [day, month, year].forEach(function (el) {
            if (!el) return;
            if (show) el.classList.add(cls); else el.classList.remove(cls);
            el.setAttribute('aria-invalid', show ? 'true' : 'false');
        });
    }

    function setGovUkErrorState(show) {
        if (!formGroup) return;
        if (show) {
            try { formGroup.classList.add('govuk-form-group--error'); } catch {}
        } else {
            try { formGroup.classList.remove('govuk-form-group--error'); } catch {}
        }
    }

    function ensureErrorEl() {
        var err = wrapper.querySelector('.govuk-error-message[data-live-date]');
        if (!err) {
            err = document.createElement('div');
            err.className = 'govuk-error-message';
            err.setAttribute('data-live-date', 'true');
            err.setAttribute('role', 'alert');
            var hintEl = wrapper.querySelector('.govuk-hint');
            if (hintEl && hintEl.parentNode) {
                hintEl.insertAdjacentElement('afterend', err);
            } else {
                wrapper.insertBefore(err, wrapper.firstChild);
            }
        }
        return err;
    }

    // Anchor used by server-side error summary links on form pages
    var fieldAnchorId = '@Model.Id';

    function hasServerRenderedError() {
        // Detect server-rendered error within the same form group (excluding live version)
        if (!formGroup) return false;
        var existing = formGroup.querySelector('.govuk-error-message:not([data-live-date])');
        if (existing) return true;
        if (formGroup.classList.contains('govuk-form-group--error')) return true;
        // Or if error summary already has a link to this field's anchor
        var summary = document.querySelector('.govuk-error-summary');
        if (summary && summary.querySelector('a[href="#' + fieldAnchorId + '"]')) return true;
        return false;
    }

    function ensureSummary() {
        var summary = document.querySelector('.govuk-error-summary');
        if (!summary) {
            summary = document.createElement('div');
            summary.className = 'govuk-error-summary';
            summary.setAttribute('role', 'alert');
            summary.setAttribute('tabindex', '-1');
            summary.setAttribute('data-live-summary', 'true');
            var title = document.createElement('h2');
            title.className = 'govuk-error-summary__title';
            title.textContent = 'There is a problem';
            var body = document.createElement('div');
            body.className = 'govuk-error-summary__body';
            var list = document.createElement('ul');
            list.className = 'govuk-list govuk-error-summary__list';
            body.appendChild(list);
            summary.appendChild(title);
            summary.appendChild(body);
            var form = wrapper.closest('form') || document.body;
            form.insertBefore(summary, form.firstChild);
        }
        try { summary.removeAttribute('hidden'); } catch {}
        var listEl = summary.querySelector('.govuk-error-summary__list');
        if (!listEl) {
            listEl = document.createElement('ul');
            listEl.className = 'govuk-list govuk-error-summary__list';
            (summary.querySelector('.govuk-error-summary__body') || summary).appendChild(listEl);
        }
        return { summary: summary, list: listEl };
    }

    function addSummaryError(message) {
        var parts = ensureSummary();
        var list = parts.list;
        // If a server-rendered entry already links to this field, skip adding live item
        var existingServerLink = list.querySelector('a[href="#' + fieldAnchorId + '"]');
        var existing = list.querySelector('li[data-live-date="true"][data-field-id="' + fieldAnchorId + '"]');
        if (existingServerLink) { return; }
        if (!existing) {
            existing = document.createElement('li');
            existing.setAttribute('data-live-date', 'true');
            existing.setAttribute('data-field-id', fieldAnchorId);
            var a = document.createElement('a');
            a.setAttribute('href', '#' + fieldAnchorId);
            a.textContent = message;
            existing.appendChild(a);
            list.appendChild(existing);
        } else {
            var link = existing.querySelector('a');
            if (link) link.textContent = message;
        }
    }

    function removeSummaryError() {
        var summary = document.querySelector('.govuk-error-summary');
        if (!summary) return;
        var list = summary.querySelector('.govuk-error-summary__list');
        if (!list) return;
        // Remove live-added error
        var existing = list.querySelector('li[data-live-date="true"][data-field-id="' + fieldAnchorId + '"]');
        if (existing) existing.remove();
        // Also remove any server-rendered entry for this field when inputs are valid
        var serverLink = list.querySelector('a[href="#' + fieldAnchorId + '"]');
        if (serverLink) {
            var li = serverLink.closest('li');
            if (li) li.remove();
        }
        var anyLeft = list.querySelector('li');
        if (!anyLeft) {
            if (summary.getAttribute('data-live-summary') === 'true') summary.remove(); else summary.setAttribute('hidden', 'true');
        }
    }

    function allPresent(vd, vm, vy) {
        return vd.length > 0 && vm.length > 0 && vy.length > 0;
    }

    function isRealDate(y, m, d) {
        // Match server behaviour (yyyy-MM-dd): require 4-digit year and a real calendar date
        if (!/^\d{4}$/.test(y)) return false;
        if (!/^\d{1,2}$/.test(m) || !/^\d{1,2}$/.test(d)) return false;
        var yi = parseInt(y, 10), mi = parseInt(m, 10), di = parseInt(d, 10);
        if (mi < 1 || mi > 12 || di < 1 || di > 31) return false;
        var dt = new Date(yi, mi - 1, di);
        return dt.getFullYear() === yi && (dt.getMonth() + 1) === mi && dt.getDate() === di;
    }

    function update() {
        var vd = (day.value || '').trim();
        var vm = (month.value || '').trim();
        var vy = (year.value || '').trim();

        if (vd || vm || vy) {
            if (!allPresent(vd, vm, vy)) {
                if (!hasServerRenderedError()) {
                    var err1 = ensureErrorEl();
                    err1.textContent = '';
                    var vh1 = document.createElement('span');
                    vh1.className = 'govuk-visually-hidden';
                    vh1.textContent = 'Error: ';
                    err1.appendChild(vh1);
                    err1.appendChild(document.createTextNode(missingMsg));
                    addSummaryError(missingMsg);
                }
                setInputsError(true);
                setGovUkErrorState(true);
                return;
            }
            if (!isRealDate(vy, vm, vd)) {
                if (!hasServerRenderedError()) {
                    var err2 = ensureErrorEl();
                    err2.textContent = '';
                    var vh2 = document.createElement('span');
                    vh2.className = 'govuk-visually-hidden';
                    vh2.textContent = 'Error: ';
                    err2.appendChild(vh2);
                    err2.appendChild(document.createTextNode(invalidMsg));
                    addSummaryError(invalidMsg);
                }
                setInputsError(true);
                setGovUkErrorState(true);
                return;
            }
        }
        // Distinguish between "no parts" and "valid full date"
        var anyEntered = (vd || vm || vy);
        if (!anyEntered) {
            // No parts entered: do not remove server-rendered errors (avoid flicker).
            // Only clear LIVE artefacts if any exist.
            var liveErr = wrapper.querySelector('.govuk-error-message[data-live-date]');
            if (liveErr) liveErr.remove();
            // Remove ONLY the live-added summary item, leave any server-linked item intact
            (function removeLiveOnly() {
                var summary = document.querySelector('.govuk-error-summary');
                if (!summary) return;
                var list = summary.querySelector('.govuk-error-summary__list');
                if (!list) return;
                var liveLi = list.querySelector('li[data-live-date="true"][data-field-id="' + fieldAnchorId + '"]');
                if (liveLi) liveLi.remove();
                // If no items remain at all, hide the server-rendered summary container
                var anyLeft = list.querySelector('li');
                if (!anyLeft) { summary.setAttribute('hidden', 'true'); }
            })();
            // Only clear client-added classes if there is no server error
            if (!hasServerRenderedError()) {
                setInputsError(false);
                setGovUkErrorState(false);
            }
        } else {
            // Valid full date: clear both live and server-rendered errors and styles
            var liveErr2 = wrapper.querySelector('.govuk-error-message[data-live-date]');
            if (liveErr2) liveErr2.remove();
            var serverErr = formGroup ? formGroup.querySelector('.govuk-error-message:not([data-live-date])') : null;
            if (serverErr) { try { serverErr.remove(); } catch {} }
            setInputsError(false);
            setGovUkErrorState(false);
            removeSummaryError();
        }
    }

    [day, month, year].forEach(function (el) {
        el.addEventListener('input', update);
        el.addEventListener('keyup', update);
        el.addEventListener('change', update);
        el.addEventListener('paste', function () { setTimeout(update, 0); });
    });

    // On form submit, remove live artefacts so server validation does not duplicate messages
    var owningForm = wrapper.closest('form');
    if (owningForm && owningForm.dataset.liveDateSubmitBound !== 'true') {
        owningForm.addEventListener('submit', function () {
            try {
                // Remove live inline errors
                owningForm.querySelectorAll('.govuk-error-message[data-live-date]').forEach(function (el) { el.remove(); });
                // Remove live-added summary items
                var summary = owningForm.querySelector('.govuk-error-summary');
                if (summary) {
                    var list = summary.querySelector('.govuk-error-summary__list');
                    if (list) {
                        list.querySelectorAll('li[data-live-date="true"]').forEach(function (li) { li.remove(); });
                    }
                    if (summary.getAttribute('data-live-summary') === 'true') {
                        var anyLeft = list && list.querySelector('li');
                        if (!anyLeft) { summary.remove(); }
                    }
                }
                // Remove error classes added by live validation
                owningForm.querySelectorAll('.govuk-input--error').forEach(function (el) { el.classList.remove('govuk-input--error'); });
                owningForm.querySelectorAll('.govuk-form-group--error').forEach(function (fg) {
                    if (fg.querySelector('.govuk-error-message[data-live-date]')) {
                        fg.classList.remove('govuk-form-group--error');
                    }
                });
            } catch {}
        });
        owningForm.dataset.liveDateSubmitBound = 'true';
    }

    update();
});
</script>
@if (hasPostedParts || hasPersistedParts)
{
    <govuk-date-input id="@Model.Id" name-prefix="Data[@Model.Field.FieldId]">
        <govuk-date-input-fieldset>
            <govuk-date-input-fieldset-legend class="govuk-fieldset__legend govuk-fieldset__legend--m @labelClasses">
                <span class="govuk-fieldset__heading">@Model.Field.Label.Value</span>
            </govuk-date-input-fieldset-legend>
            @if (!string.IsNullOrEmpty(Model.Field.Tooltip))
            {
                <govuk-date-input-hint>
                    @Model.Field.Tooltip
                </govuk-date-input-hint>
            }
            @if (Model.ErrorMessage != String.Empty)
            {
                <govuk-date-input-error-message>
                    <span class="govuk-visually-hidden">Error: </span>
                    @Model.ErrorMessage
                </govuk-date-input-error-message>
            }
        
        <govuk-date-input-day value="@(hasPostedParts ? postedDay : persistedDay)"></govuk-date-input-day>
        <govuk-date-input-month value="@(hasPostedParts ? postedMonth : persistedMonth)"></govuk-date-input-month>
        <govuk-date-input-year value="@(hasPostedParts ? postedYear : persistedYear)"></govuk-date-input-year>
        </govuk-date-input-fieldset>
    </govuk-date-input>
}
else
{
    <govuk-date-input id="@Model.Id" name-prefix="Data[@Model.Field.FieldId]" value="@parsedDate">
        <govuk-date-input-fieldset>
            <govuk-date-input-fieldset-legend class="govuk-fieldset__legend govuk-fieldset__legend--m @labelClasses">
                <span class="govuk-fieldset__heading">@Model.Field.Label.Value</span>
            </govuk-date-input-fieldset-legend>
            @if (!string.IsNullOrEmpty(Model.Field.Tooltip))
            {
                <govuk-date-input-hint>
                    @Model.Field.Tooltip
                </govuk-date-input-hint>
            }
            @if (Model.ErrorMessage != String.Empty)
            {
                <govuk-date-input-error-message>
                    @Model.ErrorMessage
                </govuk-date-input-error-message>
            }
        </govuk-date-input-fieldset>
    </govuk-date-input>
}
