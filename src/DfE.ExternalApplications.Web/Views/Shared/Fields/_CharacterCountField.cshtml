@using Microsoft.AspNetCore.Html;
@using DfE.ExternalApplications.Web.Utilities;
@model DfE.ExternalApplications.Web.Services.FieldViewModel
@{
    var maxLengthRule = Model.Field.Validations?.Where(v => v.Type == "maxLength").FirstOrDefault()?.Rule.ToString();
    int.TryParse(maxLengthRule, out var maxLengthValue);
    var labelClasses = Model.Field.Label.IsVisible ? "" : "govuk-visually-hidden";
    var maxLengthMessage = Model.Field.Validations?.Where(v => v.Type == "maxLength").FirstOrDefault()?.Message
        ?? "You have entered too many characters";
}
<govuk-character-count id="@Model.Id" name="Data[@Model.Field.FieldId]" max-length="@maxLengthValue">
    <govuk-character-count-label class="@labelClasses" asp-for="@Model.Field.FieldId">@Model.Field.Label</govuk-character-count-label>
    @{
        var (hintHtml, hintClass) = MarkdownSafe.RenderHintWithClass(Model.Field.Tooltip);
    }
    <govuk-character-count-hint class="@hintClass">
        @Html.Raw(hintHtml)
    </govuk-character-count-hint>

    @if (Model.ErrorMessage != String.Empty)
    {
        <govuk-character-count-error-message>
            <span class="govuk-visually-hidden">Error: </span>
            @Model.ErrorMessage
        </govuk-character-count-error-message>
    }
    <govuk-character-count-value>@Model.CurrentValue</govuk-character-count-value>
</govuk-character-count>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        function bindOne(textarea) {
            if (!textarea || textarea.dataset.liveMaxlengthBound === 'true') return;

            // Resolve wrapper and form group
            var wrapper = textarea.closest('.govuk-character-count') || textarea.parentElement;
            var formGroup = (wrapper && wrapper.closest('.govuk-form-group')) || textarea.closest('.govuk-form-group') || wrapper || textarea.parentElement;

            // Resolve max: textarea maxlength, wrapper data-maxlength, or server fallback
            var max = parseInt(textarea.getAttribute('maxlength'), 10);
            if (!max || isNaN(max)) {
                max = wrapper ? parseInt(wrapper.getAttribute('data-maxlength'), 10) : NaN;
            }
            if (!max || isNaN(max)) {
                max = @maxLengthValue; // from validations.rule
            }
            if (!max || isNaN(max)) return;

            var templateMsg = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Field.Validations?.FirstOrDefault(v => v.Type == "maxLength")?.Message ?? "You must enter fewer characters"));

            function ensureErrorEl() {
                var err = formGroup.querySelector('.govuk-error-message[data-live-maxlength]');
                if (!err) {
                    err = document.createElement('div');
                    err.className = 'govuk-error-message';
                    err.setAttribute('data-live-maxlength', 'true');
                    err.setAttribute('role', 'alert');
                    // Insert below the field hint but above the textarea/character count
                    var hintEl = wrapper ? wrapper.querySelector('.govuk-hint') : null;
                    if (hintEl && hintEl.parentNode) {
                        hintEl.insertAdjacentElement('afterend', err);
                    } else if (wrapper && wrapper.parentNode) {
                        wrapper.parentNode.insertBefore(err, wrapper); // fallback: above component
                    } else {
                        formGroup.insertBefore(err, formGroup.firstChild); // final fallback
                    }
                }
                return err;
            }

            function hasServerRenderedError() {
                // Detect an existing server-rendered error for this field to avoid duplicating inline messages
                if (!formGroup) return false;
                var err = formGroup.querySelector('.govuk-error-message:not([data-live-maxlength])');
                if (err) return true;
                // Also consider pre-applied error class as a server-rendered error signal
                if (formGroup.classList.contains('govuk-form-group--error')) return true;
                return false;
            }

            function setGovUkErrorState(show) {
                if (!wrapper) return;
                if (show) {
                    wrapper.classList.add('govuk-character-count--error');
                    textarea.classList.add('govuk-textarea--error');
                    if (formGroup) { try { formGroup.classList.add('govuk-form-group--error'); } catch {} }
                    // If the component has its own message element, keep it aligned
                    var msgEl = wrapper.querySelector('.govuk-character-count__message');
                    if (msgEl) { try { msgEl.setAttribute('role', 'alert'); } catch {} }
                } else {
                    wrapper.classList.remove('govuk-character-count--error');
                    textarea.classList.remove('govuk-textarea--error');
                    if (formGroup) { try { formGroup.classList.remove('govuk-form-group--error'); } catch {} }
                    var msgEl2 = wrapper.querySelector('.govuk-character-count__message');
                    if (msgEl2) { try { msgEl2.removeAttribute('role'); } catch {} }
                }
            }

            function clearError() {
                // Remove any live maxlength error
                var err = formGroup.querySelector('.govuk-error-message[data-live-maxlength]');
                if (err) err.remove();
                // Also remove any server-rendered error message within this form group to reflect current valid state
                formGroup.querySelectorAll('.govuk-error-message:not([data-live-maxlength])').forEach(function (el) {
                    el.remove();
                });
                textarea.setAttribute('aria-invalid', 'false');
                removeSummaryError();
                setGovUkErrorState(false);
            }

            function setInlineError(message) {
                // Do not add a live inline error if a server-rendered error already exists for this field
                if (hasServerRenderedError()) return null;
                var err = ensureErrorEl();
                // Clear and prepend visually hidden prefix
                err.textContent = '';
                var vh = document.createElement('span');
                vh.className = 'govuk-visually-hidden';
                vh.textContent = 'Error: ';
                err.appendChild(vh);
                err.appendChild(document.createTextNode(message));
                return err;
            }

            function update() {
                var len = (textarea.value || '').length;
                if (len > max) {
                    // If server has already rendered an error for this field, only ensure error styling; do not duplicate messages
                    if (!hasServerRenderedError()) {
                        setInlineError(templateMsg);
                        textarea.setAttribute('aria-invalid', 'true');
                        addSummaryError();
                    }
                    setGovUkErrorState(true);
                } else {
                    clearError();
                }
            }

            textarea.addEventListener('input', update);
            textarea.addEventListener('change', update);
            textarea.addEventListener('paste', function () { setTimeout(update, 0); });
            textarea.dataset.liveMaxlengthBound = 'true';
            update();

        // On form submit, wipe live validation artefacts so server-calculated errors don't duplicate
        var owningForm = textarea.closest('form');
        if (owningForm && owningForm.dataset.liveMaxlengthSubmitBound !== 'true') {
            owningForm.addEventListener('submit', function () {
                try {
                    // Remove all live maxlength inline errors in this form
                    owningForm.querySelectorAll('.govuk-error-message[data-live-maxlength]').forEach(function (el) { el.remove(); });
                    // Remove error styles added by live validation
                    owningForm.querySelectorAll('.govuk-character-count').forEach(function (cc) { cc.classList.remove('govuk-character-count--error'); });
                    owningForm.querySelectorAll('.govuk-textarea--error').forEach(function (ta) { ta.classList.remove('govuk-textarea--error'); });
                    owningForm.querySelectorAll('.govuk-form-group--error').forEach(function (fg) {
                        // Only remove where we previously added an inline live message
                        if (fg.querySelector('.govuk-error-message[data-live-maxlength]')) {
                            fg.classList.remove('govuk-form-group--error');
                        }
                    });
                    // Remove any live-added summary entries
                    var summary = owningForm.querySelector('.govuk-error-summary');
                    if (summary) {
                        var list = summary.querySelector('.govuk-error-summary__list');
                        if (list) {
                            list.querySelectorAll('li[data-live-maxlength="true"]').forEach(function (li) { li.remove(); });
                        }
                        // If the summary was created by this script and is now empty, remove it
                        if (summary.getAttribute('data-live-summary') === 'true') {
                            var anyLeft = list && list.querySelector('li');
                            if (!anyLeft) { summary.remove(); }
                        }
                    }
                } catch { }
            });
            owningForm.dataset.liveMaxlengthSubmitBound = 'true';
        }

        function ensureSummary() {
            var summary = document.querySelector('.govuk-error-summary');
            if (!summary) {
                // Create a minimal error summary if none exists
                summary = document.createElement('div');
                summary.className = 'govuk-error-summary';
                summary.setAttribute('role', 'alert');
                summary.setAttribute('tabindex', '-1');
                summary.setAttribute('data-live-summary', 'true');
                var title = document.createElement('h2');
                title.className = 'govuk-error-summary__title';
                title.textContent = 'There is a problem';
                var body = document.createElement('div');
                body.className = 'govuk-error-summary__body';
                var list = document.createElement('ul');
                list.className = 'govuk-list govuk-error-summary__list';
                body.appendChild(list);
                summary.appendChild(title);
                summary.appendChild(body);
                var form = textarea.closest('form') || document.body;
                form.insertBefore(summary, form.firstChild);
            }
            // Ensure visible if previously hidden
            try { summary.removeAttribute('hidden'); } catch {}
            var listEl = summary.querySelector('.govuk-error-summary__list');
            if (!listEl) {
                listEl = document.createElement('ul');
                listEl.className = 'govuk-list govuk-error-summary__list';
                var body = summary.querySelector('.govuk-error-summary__body') || summary;
                body.appendChild(listEl);
            }
            return { summary: summary, list: listEl };
        }

        function addSummaryError() {
            var parts = ensureSummary();
            var list = parts.list;
            // If there is already a server-rendered entry linking to this field, don't add a live one
            var existingServerLinked = list.querySelector('a[href="#' + textarea.id + '"]');
            var existing = list.querySelector('li[data-live-maxlength="true"][data-field-id="' + textarea.id + '"]');
            if (existingServerLinked) { return; }
            if (!existing) {
                existing = document.createElement('li');
                existing.setAttribute('data-live-maxlength', 'true');
                existing.setAttribute('data-field-id', textarea.id);
                var a = document.createElement('a');
                a.setAttribute('href', '#' + textarea.id);
                a.textContent = templateMsg;
                existing.appendChild(a);
                list.appendChild(existing);
            } else {
                var link = existing.querySelector('a');
                if (link) link.textContent = templateMsg;
            }
        }

        function removeSummaryError() {
            var summary = document.querySelector('.govuk-error-summary');
            if (!summary) return;
            var list = summary.querySelector('.govuk-error-summary__list');
            if (!list) return;
            // Remove live-added entry
            var existing = list.querySelector('li[data-live-maxlength="true"][data-field-id="' + textarea.id + '"]');
            if (existing) existing.remove();
            // Also remove any server-rendered entry that links to this field
            var serverLink = list.querySelector('a[href="#' + textarea.id + '"]');
            if (serverLink) {
                var li = serverLink.closest('li');
                if (li) li.remove();
            }

            // If no items remain, tidy up
            var anyItemsLeft = list.querySelector('li');
            if (!anyItemsLeft) {
                if (summary.getAttribute('data-live-summary') === 'true') {
                    // We created this summary; remove entirely
                    summary.remove();
                } else {
                    // Hide server-rendered summary if it is now empty
                    summary.setAttribute('hidden', 'true');
                }
            }
        }
        }

        // Bind all character-count textareas on the page
        document.querySelectorAll('.govuk-character-count textarea').forEach(bindOne);

        // Fallback: try by name if needed (in case markup deviates)
        var fallback = document.querySelector('textarea[name="Data[@Model.Field.FieldId]"]');
        if (fallback) bindOne(fallback);
    });
</script>