@using DfE.ExternalApplications.Domain.Models
@using DfE.ExternalApplications.Web.Utilities
@using GovUk.Frontend.AspNetCore.TagHelpers
@using Microsoft.AspNetCore.Mvc.TagHelpers
@model RenderFormModel
@{
    var task = Model.CurrentTask;
    var summary = task?.Summary;
}

@if (!string.IsNullOrEmpty(Model.SuccessMessage))
{
    <div class="govuk-notification-banner govuk-notification-banner--success" role="alert" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner">
        <div class="govuk-notification-banner__header">
            <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
                Success
            </h2>
        </div>
        <div class="govuk-notification-banner__content">
            <p class="govuk-notification-banner__heading">
                @DisplayHelpers.UnsanitiseHtmlInput(Model.SuccessMessage)
            </p>
        </div>
    </div>
}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
        <!-- Display validation errors if any -->
        @if (!ViewData.ModelState.IsValid)
        {
            <govuk-error-summary>
                @foreach (var error in ViewData.ModelState.Where(m => m.Value.Errors.Any()))
                {
                    @foreach (var errorMsg in error.Value.Errors)
                    {
                        <govuk-error-summary-item>
                            <span class="govuk-visually-hidden">Error: </span>@errorMsg.ErrorMessage
                        </govuk-error-summary-item>
                    }
                }
            </govuk-error-summary>
        }
        
        <!-- Custom page title and description -->
        <h1 class="govuk-heading-l">@(summary?.Title ?? task?.TaskName)</h1>
        
        @if (!string.IsNullOrEmpty(summary?.Description))
        {
            var (hintHtml, hintClass) = MarkdownSafe.RenderHintWithClass(summary.Description);

            <div class="govuk-body">@Html.Raw(hintHtml)</div>
        }
       

        @if (summary?.DerivedFlows != null && summary.DerivedFlows.Any())
        {
            @foreach (var derivedFlow in summary.DerivedFlows.OrderBy(f => f.SectionOrder))
            {
                @await Html.PartialAsync("~/Views/Shared/FormEngine/_SingleDerivedFlow.cshtml", 
                    new Tuple<RenderFormModel, DerivedCollectionFlowConfiguration>(Model, derivedFlow))
            }
        }
        else
        {
            <p class="govuk-body">No derived flows configured for this task.</p>
        }

        @if (Model.IsApplicationEditable())
        {
            <form method="post" action="/applications/@Model.ReferenceNumber/@Model.TaskId?handler=Page">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="TaskId" />
                <div class="govuk-checkboxes__item">
                    <input class="govuk-checkboxes__input" 
                           id="IsTaskCompleted" 
                           name="IsTaskCompleted" 
                           type="checkbox" 
                           value="true"
                           @(Model.IsTaskCompleted ? "checked" : "")>
                    <label class="govuk-label govuk-checkboxes__label" for="IsTaskCompleted">
                        Mark this section as complete, it's ready for review
                    </label>
                </div>
                <button type="submit" class="govuk-button govuk-!-margin-top-4" id="save-task-summary-button">Save and continue</button>
            </form>
        }
    </div>
</div>
