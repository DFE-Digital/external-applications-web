@model DfE.ExternalApplications.Web.Pages.FormEngine.RenderFormModel
@using DfE.ExternalApplications.Application.Interfaces
@using GovUk.Frontend.AspNetCore.TagHelpers
@using System.Text.Json

@{
    // Extract confirmation parameters from the pageId
    var pageIdParts = Model.CurrentPageId?.Split('/', StringSplitOptions.RemoveEmptyEntries) ?? Array.Empty<string>();
    var operation = pageIdParts.Length > 1 ? pageIdParts[1] : string.Empty;
    var fieldId = pageIdParts.Length > 2 ? pageIdParts[2] : string.Empty;
    var confirmationToken = pageIdParts.Length > 3 ? pageIdParts[3] : string.Empty;
    
    // Check if we have the required data
    var hasRequiredData = !string.IsNullOrEmpty(operation) && !string.IsNullOrEmpty(fieldId) && !string.IsNullOrEmpty(confirmationToken);
    var hasFormData = Model.Data != null && Model.Data.Any();
}

@if (!hasRequiredData)
{
    <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1" data-module="govuk-error-summary">
        <h2 class="govuk-error-summary__title" id="error-summary-title">
            There is a problem
        </h2>
        <div class="govuk-error-summary__body">
            <ul class="govuk-list govuk-error-summary__list">
                <li>
                    <a href="#error-message">Missing required confirmation data. Please return to the previous page and try again.</a>
                </li>
            </ul>
        </div>
    </div>
}
else
{
    <!-- Back link -->
    <govuk-back-link href="/applications/@Model.ReferenceNumber/@Model.TaskId">Back to search for a trust</govuk-back-link>

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            
            @if (hasFormData && Model.Data.ContainsKey(fieldId))
            {
                var value = Model.Data[fieldId];
                var valueString = value?.ToString() ?? string.Empty;
                
                <div class="govuk-form-group">
                    <fieldset class="govuk-fieldset" aria-describedby="trust-confirmed-hint">
                        <legend class="govuk-fieldset__legend govuk-fieldset__legend--l">
                            <h1 class="govuk-fieldset__heading">
                                <span class="govuk-caption-l">Trust details</span>
                                Is this the right trust?
                            </h1>
                        </legend>
                        
                        <div id="trust-confirmed-hint" class="govuk-hint">
                            <div class="govuk-inset-text">
                                @if (!string.IsNullOrWhiteSpace(valueString))
                                {
                                    try
                                    {
                                        // Try to parse as JSON for complex field values (like trust selection data)
                                        if (valueString.StartsWith("{") || valueString.StartsWith("["))
                                        {
                                            var jsonValue = JsonSerializer.Deserialize<JsonElement>(valueString);
                                            if (jsonValue.ValueKind == JsonValueKind.Object && jsonValue.TryGetProperty("name", out var nameElement))
                                            {
                                                var trustName = nameElement.GetString();
                                                
                                                <h2 class="govuk-heading-m">@trustName</h2>
                                                
                                                @if (jsonValue.TryGetProperty("ukprn", out var ukprnElement))
                                                {
                                                    <p class="govuk-body">UKPRN: @ukprnElement.GetString()</p>
                                                }
                                                
                                                @if (jsonValue.TryGetProperty("companiesHouseNumber", out var companiesHouseElement))
                                                {
                                                    <p class="govuk-body">Companies house number: @companiesHouseElement.GetString()</p>
                                                }
                                            }
                                            else if (jsonValue.ValueKind == JsonValueKind.Array)
                                            {
                                                <h2 class="govuk-heading-m">@jsonValue.GetArrayLength() item(s) selected</h2>
                                            }
                                            else
                                            {
                                                <h2 class="govuk-heading-m">@valueString</h2>
                                            }
                                        }
                                        else
                                        {
                                            <h2 class="govuk-heading-m">@valueString</h2>
                                        }
                                    }
                                    catch (JsonException)
                                    {
                                        <h2 class="govuk-heading-m">@valueString</h2>
                                    }
                                }
                                else
                                {
                                    <p class="govuk-body">
                                        <strong>Note:</strong> Trust details could not be loaded. Please proceed with caution.
                                    </p>
                                }
                            </div>
                        </div>
                    </fieldset>
                </div>
            }
            else
            {
                <div class="govuk-form-group">
                    <fieldset class="govuk-fieldset" aria-describedby="trust-confirmed-hint">
                        <legend class="govuk-fieldset__legend govuk-fieldset__legend--l">
                            <h1 class="govuk-fieldset__heading">
                                <span class="govuk-caption-l">Trust details</span>
                                Is this the right trust?
                            </h1>
                        </legend>
                        
                        <div id="trust-confirmed-hint" class="govuk-hint">
                            <div class="govuk-inset-text">
                                <p class="govuk-body">
                                    <strong>Note:</strong> Trust details could not be loaded. Please proceed with caution.
                                </p>
                            </div>
                        </div>
                    </fieldset>
                </div>
            }

            <!-- Confirmation form -->
            <form method="post" action="?handler=Confirmation">
                @Html.AntiForgeryToken()
                <input type="hidden" name="Operation" value="@operation" />
                <input type="hidden" name="FieldId" value="@fieldId" />
                <input type="hidden" name="ConfirmationToken" value="@confirmationToken" />

                <!-- Radio buttons for confirmation -->
                <div class="govuk-form-group">
                    <fieldset class="govuk-fieldset">
                        <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
                            <h2 class="govuk-fieldset__heading">Please confirm your choice</h2>
                        </legend>
                        
                        <div class="govuk-radios" data-module="govuk-radios" data-govuk-radios-init="">
                            <div class="govuk-radios__item">
                                <input class="govuk-radios__input" id="UserConfirmed-true" name="UserConfirmed" type="radio" value="true" required>
                                <label class="govuk-label govuk-radios__label" for="UserConfirmed-true">
                                    Yes
                                </label>
                            </div>
                            
                            <div class="govuk-radios__item">
                                <input class="govuk-radios__input" id="UserConfirmed-false" name="UserConfirmed" type="radio" value="false" required>
                                <label class="govuk-label govuk-radios__label" for="UserConfirmed-false">
                                    No
                                </label>
                            </div>
                        </div>
                    </fieldset>
                </div>

                <button type="submit" class="govuk-button" data-module="govuk-button" data-govuk-button-init="">
                    Continue
                </button>
            </form>
        </div>
    </div>
}
